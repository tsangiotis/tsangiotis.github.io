---
layout: post
title: An easy Media Server and Time Machine
date: 2014-06-17 13:27:00.000000000 +03:00
type: post
published: true
status: publish
categories:
- Guides
- Projects
tags:
- Automation
- Plex
- Time Machine
meta:
  _edit_last: '1'
  _thumbnail_id: '787838'
  _jetpack_dont_email_post_to_subs: '1'
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1477033365;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:894972;}i:1;a:1:{s:2:"id";i:902216;}i:2;a:1:{s:2:"id";i:1095522;}}}}
author:
  login: tsangiotis
  email: tsangiotis@gmail.com
  display_name: Tasos Sangiotis
  first_name: Tasos
  last_name: Sangiotis
---
<div class="posthaven-post-body">
<p>I hate mess... So I like remote solutions!</p>
<p>One thing that bothers me is the USB cable that I always have connected on my computer.<br />
On it's other end, lies a 1TB Hard Drive that stores my Time Machine backup.</p>
<p>From time to time I stream movies via <a href="http://plexapp.com/">Plex</a> from the same hard disk.<br />
That's because I don't want to store movies on my low capacity Macbook Air.</p>
<p>Since I got my Chromecast, Plex has gone to the top of my "Useful Software" list as it supports Chromecast and I can stream the Movies without connecting a HDMI cable.</p>
<p>So what I need? A HDD in my network that hosts my media and my backups.</p>
<div id="posthaven_gallery[770086]" class="posthaven-gallery">
<p class="posthaven-file posthaven-file-image posthaven-file-state-processed"><img class="posthaven-gallery-image" src="{{ site.baseurl }}/assets/1-4.png" /></p>
</div>
<p>Nice, but not so cheap.</p>
<p>Using a spare very low powered netbook and the Time Machine HDD, I managed to put away these 2 functions from my laptop.</p>
<p>I could also get torrents directly on my netbook. Life would be easier...</p>
<p><em>Let's do it!</em></p>
<h1>Preparation</h1>
<h2>What we will need</h2>
<ul>
<li>We need something debian-based. Preferably use your old computer or netbook but not your Rasperry Pi as Plex does not support it officialy yet (I think). You can check your chances with <a href="http://www.rasplex.com/">RasPlex</a> if you feel like it.
<ul>
<li>I used <strong>Ubuntu Server 14.04 LTS 32bit</strong> on an old Lenovo ideapad.</li>
</ul>
</li>
<li>A large enough Hard Drive. TB has gone pretty cheap lately.</li>
<li>An afternoon.</li>
</ul>
<h2>Format the Hard Drive</h2>
<p>Put the HDD on OS X and create a big partition for the Time Machine using Disk Utility.</p>
<p>Leave the rest Unallocated.</p>
<blockquote><p>Remeber <strong>not</strong> to have spaces on the disk labels. I used <strong>timemachine</strong>and <strong>diskspace</strong></p></blockquote>
<p>Next holding <code>option</code> click partition from the sidebar and Disable Journaling.<br />
We do this to ensure compatibility on case of restore.</p>
<p>Then on linux format the rest as <code>ext2</code>, <code>ext3</code> or <code>ext4</code>.</p>
<p>You can use <a href="http://www.gnu.org/software/parted/manual/html_chapter/parted_2.html">parted</a> for that.</p>
<h1>Setup system</h1>
<p>Use <code>blkid</code> to check your Partiotions UUIDs and note them.<br />
The <code>sdb</code> ones are the ones we care about.</p>
<pre><code>sudo blkid
/dev/sda1: UUID="dadbbcb0-0680-4633-b6a5-ebea09359478" TYPE="ext2"
/dev/sda5: UUID="PnN6eH-eipf-Rq1w-ddfi-FCf3-w23k-5NDAcE" TYPE="LVM2_member"
/dev/mapper/ideapad--vg-root: UUID="ab0966d5-eba5-4ca2-aeca-62234b4ce71f" TYPE="ext4"
/dev/mapper/ideapad--vg-swap_1: UUID="54745ca7-cb41-432f-aa3e-92ec708248e6" TYPE="swap"
/dev/sdb1: UUID="e14664bf-85bb-4265-99e3-787e454da730" TYPE="ext2"
/dev/sdb3: UUID="744f07e4-2075-34f5-811f-df6b37e2d2a7" LABEL="timemachine" TYPE="hfsplus"
</code></pre>
<p>Now create the mount points and give them the right permissions.</p>
<pre><code>sudo mkdir /media/timemachine /media/tm_backup
sudo mkdir /media/diskspace /media/diskspace/transmission /media/diskspace/completed
sudo mkdir /media/diskspace/incomplete /media/diskspace/torrents
sudo chown -R tsagi:tsagi /media/diskspace/
sudo chown -R tsagi:tsagi /media/timemachine/
</code></pre>
<p>Add the settings to the end <code>/etc/fstab</code> so they mount on startup.</p>
<pre><code>UUID=e14664bf-85bb-4265-99e3-787e454da730 /media/diskspace ext2 defaults 0 0
UUID=744f07e4-2075-34f5-811f-df6b37e2d2a7 /media/timemachine hfsplus force,rw 0 0
</code></pre>
<p>Then reboot.</p>
<h1>Time Machine</h1>
<h2>Linux Server</h2>
<p>First install Netatalk:</p>
<pre><code>sudo apt-get install netatalk
</code></pre>
<p>Edit /etc/netatalk/afpd.conf with your favorite editor and add the following line at the end (comment out every other line that might be active):</p>
<pre><code>- -tcp -noddp -uamlist uams_dhx.so,uams_dhx2_passwd.so -nosavepassword

</code></pre>
<div><code>This will define the afpd server (Netatalk).</code></div>
<p>Next make sure your /etc/default/netatalk file shows CNID_METAD_RUN=yes.<br />
This will ensure that all the metadata that is needed by OS X is handled and saved by an extra daemon on the side, too.</p>
<p>Now add the following to <code>/etc/netatalk/AppleVolumes.default</code>:</p>
<pre><code>/media/timemachine/tm_backup "Time Machine" allow:username cnidscheme:dbd volsizelimit:650000 options:usedots,upriv,tm
</code></pre>
<p>Adjust the location of the directory and the username to your needs. The example above also limits the size shown to OS X as 650 GB (the number is given in MiB, so it's 650.000 times 1024 in the real world). Also note that the tm option is only option separating a Time Machine capable directory from a regular afp share.</p>
<p>You should also edit the <code>:DEFAULT</code> property on<code>/etc/netatalk/AppleVolumes.default</code> file to match this:</p>
<pre><code>:DEFAULT: cnidscheme:dbd options:upriv,usedots
</code></pre>
<p>Restart the Netatalk daemon to make sure it uses the newly adjusted configurations:</p>
<pre><code>sudo service netatalk restart
</code></pre>
<p>We are now done configuring the server.</p>
<h2>OS X Client</h2>
<p>Open up <strong>Finder</strong> and press <code>Command + K</code> to bring up the "Connect to Server" dialog.</p>
<p>Connect to server dialog</p>
<p>Enter <strong>afp://ip_address_of_your_server</strong>, press Enter and select the according share from the list.<br />
Fill in username and password from the user <strong>on the server</strong> (not the one on the Mac) and see if you have access to the share.<br />
If everything works well, continue with the Time Machine preferences.</p>
<p>In the system preferences on your Mac, select Time Machine and click on "Select Disk..."</p>
<p>Select your share from the list, edit the other options like excluded directories and automatic backups to your liking and enjoy this cheap and reliable Time Machine solution!<br />
The first backup might take quite some time, depending on your network and hard drive speed. All the following backups will be incremental and a lot faster.</p>
<p><strong>Bonus:</strong> you don't even have to manually connect to the server share before a backup. Time Machine will let its magic happen and auto-mount / un-mount the share whenever it is needed. Peace of mind in a box.</p>
<p><em>Credits:</em> I used <strong><a href="http://pwntr.com/2012/03/03/easy-mac-os-x-lion-10-7-time-machine-backup-using-an-ubuntu-linux-server-11-10-12-04-lts-and-up/">this</a></strong> guide with some changes I made.</p>
<p>Useful links:</p>
<p><a href="http://netatalk.sourceforge.net/2.2/htmldocs/afpd.conf.5.html">afpd.conf manpage</a></p>
<p><a href="http://netatalk.sourceforge.net/2.2/htmldocs/AppleVolumes.default.5.html">AppleVolumes.default manpage</a></p>
<h1>Media Server</h1>
<p>What it takes to make the perfect media server for me?</p>
<p>Just a good torrent client and Plex!</p>
<p>Let's get to it!</p>
<h2>Torrents</h2>
<p>For the torrent client I just used <a href="https://www.transmissionbt.com/">Transmission</a>. It is more than good and it has a clean remote UI.</p>
<div id="posthaven_gallery[770087]" class="posthaven-gallery">
<p class="posthaven-file posthaven-file-image posthaven-file-state-processed"><img class="posthaven-gallery-image" src="{{ site.baseurl }}/assets/2-3.png" /></p>
</div>
<p>First get Transmission:</p>
<pre><code>sudo add-apt-repository ppa:transmissionbt/ppa
sudo apt-get update
sudo apt-get install transmission-cli transmission-common transmission-daemon
</code></pre>
<p>We should add our user to the <code>debian-transmission</code> group.</p>
<pre><code>sudo usermod -a -G debian-transmission user
</code></pre>
<p>Remember the directories we created earlier?<br />
Let's give the correct permissions.</p>
<pre><code>sudo chmod -R 775 /media/diskspace/transmission
</code></pre>
<p>Now stop the daemon to configure transmission.</p>
<pre><code>sudo service transmission-daemon stop
</code></pre>
<p>Backup the default settings:</p>
<pre><code>cd /etc/transmission-daemon
sudo cp -a settings.json settings.json.default
</code></pre>
<p>Then create a transmission settings directory in your home folder (example:<code>/home/user/.config/transmission-daemon</code>), copy settings.json into it, and change its permissions to make it accessible to transmission-daemon:</p>
<pre><code>mkdir /home/user/.config/transmission-daemon
sudo cp -a /etc/transmission-daemon/settings.json transmission-daemon/
sudo chgrp -R debian-transmission /home/user/.config/transmission-daemon
sudo chmod -R 770 /home/user/.config/transmission-daemon
</code></pre>
<p>Then, remove <code>/etc/transmission-daemon/settings.json</code>, create a symbolic link in the <code>/etc/transmission-daemon</code> folder, and edit it permissions to make it accessible to Transmission and the user account:</p>
<pre><code>cd /etc/transmission-daemon
sudo rm settings.json
sudo ln -s /home/user/.config/transmission-daemon/settings.json settings.json
sudo chgrp -R debian-transmission /etc/transmission-daemon/settings.json
sudo chmod -R 770 /etc/transmission-daemon/settings.json
</code></pre>
<p>You can now start editing <code>/home/user/.config/transmission-daemon/settings.json</code>without worries of losing your settings.</p>
<p>You can copy mine but remember to change your settings and password if they don't agree:</p>
<pre><code>{
    "alt-speed-down": 500,
    "alt-speed-enabled": false,
    "alt-speed-time-begin": 540,
    "alt-speed-time-day": 127,
    "alt-speed-time-enabled": false,
    "alt-speed-time-end": 1020,
    "alt-speed-up": 1,
    "bind-address-ipv4": "0.0.0.0",
    "bind-address-ipv6": "::",
    "blocklist-enabled": false,
    "blocklist-updates-enabled": true,
    "blocklist-url": "http://www.example.com/blocklist",
    "cache-size-mb": 4,
    "dht-enabled": true,
    "download-dir": "/media/diskspace/transmission/completed",
    "download-limit": 100,
    "download-limit-enabled": 0,
    "download-queue-enabled": true,
    "download-queue-size": 5,
    "encryption": 2,
    "filter-mode": "show-all",
    "idle-seeding-limit": 30,
    "idle-seeding-limit-enabled": false,
    "incomplete-dir": "/media/diskspace/transmission/incomplete",
    "incomplete-dir-enabled": true,
    "inhibit-desktop-hibernation": false,
    "lazy-bitfield-enabled": true,
    "lpd-enabled": false,
    "main-window-height": 500,
    "main-window-is-maximized": 0,
    "main-window-layout-order": "menu,toolbar,filter,list,statusbar",
    "main-window-width": 467,
    "main-window-x": 50,
    "main-window-y": 50,
    "max-peers-global": 200,
    "message-level": 2,
    "minimal-view": false,
    "open-dialog-dir": "/media/diskspace",
    "open-file-limit": 32,
    "peer-congestion-algorithm": "",
    "peer-id-ttl-hours": 6,
    "peer-limit-global": 240,
    "peer-limit-per-torrent": 60,
    "peer-port": 9071,
    "peer-port-random-high": 9098,
    "peer-port-random-low": 9026,
    "peer-port-random-on-start": true,
    "peer-socket-tos": "default",
    "pex-enabled": true,
    "play-download-complete-sound": true,
    "port-forwarding-enabled": false,
    "preallocation": 1,
    "prefetch-enabled": 1,
    "prompt-before-exit": true,
    "proxy": "",
    "proxy-auth-enabled": false,
    "proxy-auth-password": "",
    "proxy-auth-username": "",
    "proxy-enabled": false,
    "proxy-port": 80,
    "proxy-type": 0,
    "queue-stalled-enabled": true,
    "queue-stalled-minutes": 30,
    "ratio-limit": 1.5000,
    "ratio-limit-enabled": true,
    "rename-partial-files": true,
    "rpc-authentication-required": true,
    "rpc-bind-address": "0.0.0.0",
    "rpc-enabled": true,
    "rpc-password": "{c371b29b1eb8a1164023ef4a13013e7583d8a736E5n9jnT/",
    "rpc-port": 9025,
    "rpc-url": "/transmission/",
    "rpc-username": "tsagi",
    "rpc-whitelist": "127.0.0.1,*.*.*.*",
    "rpc-whitelist-enabled": true,
    "scrape-paused-torrents-enabled": true,
    "script-torrent-done-enabled": false,
    "script-torrent-done-filename": "",
    "seed-queue-enabled": false,
    "seed-queue-size": 10,
    "show-backup-trackers": false,
    "show-desktop-notification": true,
    "show-extra-peer-details": false,
    "show-filterbar": true,
    "show-notification-area-icon": false,
    "show-options-window": true,
    "show-statusbar": true,
    "show-toolbar": true,
    "show-tracker-scrapes": false,
    "sort-mode": "sort-by-name",
    "sort-reversed": false,
    "speed-limit-down": 0,
    "speed-limit-down-enabled": false,
    "speed-limit-up": 1,
    "speed-limit-up-enabled": true,
    "start-added-torrents": true,
    "statusbar-stats": "total-ratio",
    "trash-original-torrent-files": false,
    "umask": 2,
    "upload-limit": 100,
    "upload-limit-enabled": 0,
    "upload-slots-per-torrent": 4,
    "user-has-given-informed-consent": true,
    "utp-enabled": true,
    "watch-dir": "/media/diskspace/transmission/torrents",
    "watch-dir-enabled": true
}
</code></pre>
<p>Now start the daemon and test the setup heading to<code>http://your.server.ip.adress:9025/</code></p>
<pre><code>sudo service transmission-daemon start</code></pre>
<h2>Plex</h2>
<p>Finaly we need to set up Plex.</p>
<p>Go to <a href="https://plex.tv/downloads">Plex website</a> and copy the link for the appropriate version for your setup. I got the 32bit Ubuntu version.</p>
<p>Download it and install it.</p>
<pre><code>wget http://downloads.plexapp.com/plex-media-server/0.9.9.12.504-3e7f93c/plexmediaserver_0.9.9.12.504-3e7f93c_i386.deb
sudo dpkg -i plexmediaserver_0.9.9.12.504-3e7f93c_i386.deb
</code></pre>
<p>Next give plex the permissions it needs:</p>
<pre><code>sudo gpasswd -a plex tsagi
</code></pre>
<p>Go to <code>http://your.server.ip.adress:32400/manage</code> and point your libraries to the transmission's <code>completed</code> directory. It can figure out if you have a series episode or a movie in the directory.</p>
<div id="posthaven_gallery[770085]" class="posthaven-gallery">
<p class="posthaven-file posthaven-file-image posthaven-file-state-processed"><img class="posthaven-gallery-image" src="{{ site.baseurl }}/assets/4.png" /></p>
</div>
<div></div>
<p><a name="more"></a></p>
<p><em>Liked it? </em><a href="http://eepurl.com/bIEi_9"><em>Every week I send an email</em></a><em>. It involves:</em></p>
<ul>
<li><em>Interesting things from the internet world.</em></li>
<li><em>Discussions on pressing matters.</em></li>
<li><em>Some personal additions.</em></li>
<li><em>Many surprises!</em></li>
</ul>
<p><a href="http://eepurl.com/bIEi_9"><em>Join now</em></a><em> and enjoy every Friday in your inbox! </em><a href="http://eepurl.com/bIEi_9"><em>Sign Up here!</em></a></p>
</div>
